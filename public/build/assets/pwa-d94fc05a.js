document.addEventListener("DOMContentLoaded",function(){m(),y()});function m(){const e=document.getElementById("pwa-install-widget"),t=document.getElementById("install-pwa"),i=document.querySelector(".close-pwa-widget");if(!e)return;let n,o=v();g(o),i&&i.addEventListener("click",()=>{l()}),t&&t.addEventListener("click",()=>{r()}),window.addEventListener("beforeinstallprompt",a=>{a.preventDefault(),n=a,o!=="ios"&&(t.style.display="flex"),f()||c()}),o==="ios"&&!f()&&setTimeout(()=>{c()},3e3),window.addEventListener("appinstalled",a=>{s(),typeof ym<"u"&&ym(100639873,"reachGoal","pwa_installed"),console.log("PWA was installed")});function r(){if(!n){console.log("Installation prompt not available");return}n.prompt(),n.userChoice.then(a=>{a.outcome==="accepted"?(console.log("User accepted the install prompt"),typeof ym<"u"&&ym(100639873,"reachGoal","pwa_install_accepted")):(console.log("User dismissed the install prompt"),typeof ym<"u"&&ym(100639873,"reachGoal","pwa_install_dismissed")),n=null})}function c(){e.style.display="block",setTimeout(()=>{e.classList.add("show")},10),typeof ym<"u"&&ym(100639873,"reachGoal","pwa_widget_shown")}function s(){e.classList.remove("show"),setTimeout(()=>{e.style.display="none"},300)}function l(){localStorage.setItem("pwaInstallDismissed",Date.now().toString()),s(),typeof ym<"u"&&ym(100639873,"reachGoal","pwa_widget_dismissed")}function f(){const a=localStorage.getItem("pwaInstallDismissed");if(!a)return!1;const p=Date.now(),w=parseInt(a),u=24*60*60*1e3;return p-w<3*u}}function g(e){const t=document.querySelector(".pwa-widget-content"),i=document.querySelector(".device-icon"),n=document.getElementById("install-pwa");if(!t||!i)return;let o="fas fa-mobile-alt";switch(e){case"ios":o="fab fa-apple";break;case"android":o="fab fa-android";break;case"windows":o="fab fa-windows";break}switch(i.className=o+" device-icon",e){case"ios":t.innerHTML=`
                <p>Установите наше приложение на свой iPhone/iPad:</p>
                <ol>
                    <li>Нажмите на <strong><i class="fas fa-share"></i> Поделиться</strong> в Safari</li>
                    <li>Прокрутите вниз и нажмите <strong>"На экран «Домой»"</strong></li>
                    <li>Нажмите <strong>"Добавить"</strong> в верхнем правом углу</li>
                </ol>
            `,n&&(n.style.display="none");break;case"android":t.innerHTML=`
                <p>Установите наше приложение на свой Android:</p>
                <p>Нажмите на кнопку "Установить приложение" ниже</p>
            `;break;case"windows":t.innerHTML=`
                <p>Установите наше приложение на свой компьютер:</p>
                <p>Нажмите на кнопку "Установить приложение" ниже или на значок установки <i class="fas fa-plus-square"></i> в адресной строке браузера</p>
            `;break;default:t.innerHTML=`
                <p>Установите наше приложение для быстрого доступа:</p>
                <p>Нажмите на кнопку "Установить приложение" ниже</p>
            `}}function v(){const e=navigator.userAgent||navigator.vendor||window.opera;return/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"ios":/android/i.test(e)?"android":/Windows NT/.test(e)?"windows":"other"}function y(){const e=()=>{const t=navigator.onLine?"online":"offline";console.log(`App is now ${t}`);const i=document.getElementById("offline-message");i&&(t==="offline"?i.classList.remove("d-none"):i.classList.add("d-none"))};if(window.addEventListener("online",e),window.addEventListener("offline",e),e(),"localStorage"in window){const t=document.getElementById("pwa-data");if(t&&t.dataset.recipe)try{const i=JSON.parse(t.dataset.recipe);let n=JSON.parse(localStorage.getItem("recent_recipes")||"[]");const o=n.findIndex(r=>r.id===i.id);o>-1&&n.splice(o,1),n.unshift(i),n=n.slice(0,10),localStorage.setItem("recent_recipes",JSON.stringify(n)),console.log("Recipe cached for offline access")}catch(i){console.error("Error caching recipe:",i)}}}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/service-worker.js").then(e=>{console.log("Service Worker зарегистрирован с областью:",e.scope)}).catch(e=>{console.error("Ошибка регистрации Service Worker:",e)})});let d;function h(){const e=navigator.userAgent||navigator.vendor||window.opera;return/android/i.test(e)?"android":/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"ios":"windows"}function S(){const e=h();console.log("Обнаружено устройство:",e);const t=document.getElementById("pwa-install-widget");if(!t||window.matchMedia("(display-mode: standalone)").matches)return;window.addEventListener("beforeinstallprompt",n=>{n.preventDefault(),d=n,t.classList.add("show");const o=t.querySelector(".device-icon");t.querySelector(".pwa-install-instructions"),o&&(o.className="device-icon "+e);const r=t.querySelector(".close-pwa-widget");r&&(r.addEventListener("touchstart",s=>{s.preventDefault(),t.classList.remove("show"),localStorage.setItem("pwa-install-dismissed",new Date().toString())}),r.addEventListener("touchmove",s=>{s.preventDefault()}));const c=t.querySelector(".install-pwa-btn");c&&d&&c.addEventListener("click",async()=>{var l;d.prompt();const{outcome:s}=await d.userChoice;s==="accepted"?(console.log("Пользователь принял установку PWA"),t.classList.remove("show"),fetch("/pwa/track-install",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((l=document.querySelector('meta[name="csrf-token"]'))==null?void 0:l.getAttribute("content"))||""},body:JSON.stringify({device:e})})):console.log("Пользователь отклонил установку PWA"),d=null})});const i=localStorage.getItem("pwa-install-dismissed");if(i){const n=new Date(i);if(new Date-n<7*24*60*60*1e3)return}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").then(n=>{console.log("Service Worker зарегистрирован:",n)}).catch(n=>{console.error("Ошибка регистрации Service Worker:",n)})})}document.addEventListener("DOMContentLoaded",S);
